<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>3D Mitochondrial Morphology and Quantification</title>

<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

<style>
body {
  display: flex;
  flex-direction: column;
  align-items: center;
  font-family: sans-serif;
  margin: 20px;
  background: #fafafa;
}

h1 {
  margin-bottom: 15px;
}

/* CATEGORY BUTTONS */
.category-buttons {
  margin-bottom: 20px;
}

.label {
  font-weight: bold;
  margin: 10px 0 5px;
}

.timepoint-buttons, .dose-buttons {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  margin-bottom: 10px;
}

button {
  margin: 0 5px;
  padding: 8px 12px;
  font-size: 1rem;
  cursor: pointer;
  border-radius: 6px;
  border: 2px solid #bbb;
  background: #e6e6e6;
  color: #222;
}

button.active {
  background: #2563eb;
  color: #fff;
  border-color: #2563eb;
}
model-viewer {
  width: 90vw;
  max-width: 500px;
  aspect-ratio: 1 / 1;   /* makes it square */
  height: auto;
  margin-bottom: 20px;
  background-color: #f0f0f0;
  border-radius: 10px;
}

/* QUANTIFICATION */
.quant-container {
  max-width: 800px;
  text-align: center;
}

.quant-container img {
  width: 100%;
  border-radius: 10px;
  margin-bottom: 15px;
}

.quant-description {
  background: #fff;
  padding: 15px;
  border-radius: 10px;
  border: 1px solid #ddd;
  text-align: left;
}
</style>
</head>

<body>

<h1>3D Mitochondrial Morphology and Membrane Potential</h1>

<!-- CATEGORY SWITCH -->
<div class="category-buttons">
  <button id="tmreBtn">TMRE Models</button>
  <button id="quantBtn">Quantification</button>
</div>

<!-- ===================== -->
<!-- TMRE MODELS SECTION -->
<!-- ===================== -->
<div id="tmre-section">

  <div class="label">Timepoint</div>
  <div class="timepoint-buttons" id="timepoint-buttons"></div>

  <div class="label">Dose</div>
  <div class="dose-buttons" id="dose-buttons"></div>

  <model-viewer
    id="viewer"
    src=""
    alt="3D model"
    camera-controls
    auto-rotate
    shadow-intensity="1"
    exposure="1">
  </model-viewer>

  <button id="toggleTMRE">Hide TMRE</button>
</div>

<!-- ===================== -->
<!-- QUANTIFICATION SECTION -->
<!-- ===================== -->
<div id="quant-section" style="display:none;" class="quant-container">

  <img src="images/quantification.png" alt="Quantification Results">

  <div class="quant-description">
    <h3>Quantification</h3>
    <p>
      Quantitative analysis of mitochondrial membrane potential
      across treatment doses and timepoints normalized to control.
    </p>
  </div>

</div>

<script>
/* ------------------ CATEGORY TOGGLE ------------------ */
const tmreBtn = document.getElementById('tmreBtn');
const quantBtn = document.getElementById('quantBtn');
const tmreSection = document.getElementById('tmre-section');
const quantSection = document.getElementById('quant-section');

tmreBtn.onclick = () => {
  tmreSection.style.display = "block";
  quantSection.style.display = "none";
  tmreBtn.classList.add("active");
  quantBtn.classList.remove("active");
};

quantBtn.onclick = () => {
  tmreSection.style.display = "none";
  quantSection.style.display = "block";
  quantBtn.classList.add("active");
  tmreBtn.classList.remove("active");
};

tmreBtn.classList.add("active");

/* ------------------ MODEL LOGIC ------------------ */
const viewer = document.getElementById('viewer');
const tpButtonsDiv = document.getElementById('timepoint-buttons');
const doseButtonsDiv = document.getElementById('dose-buttons');

const timepoints = {
  "0HR": [
    { name: "models/DMSO_0HR.glb", label: "DMSO" },
    { name: "models/100_0HR.glb", label: "100 µM" },
    { name: "models/300_0HR.glb", label: "300 µM" }
  ],
  "6HR": [
    { name: "models/DMSO_max.glb", label: "DMSO" },
    { name: "models/100_6HR.glb", label: "100 µM" },
    { name: "models/300_6HR.glb", label: "300 µM" }
  ],
  "24HR": [
    { name: "models/DMSO_24HR.glb", label: "DMSO" },
    { name: "models/100_24HR.glb", label: "100 µM" },
    { name: "models/300_24HR.glb", label: "300 µM" }
  ],
  "72HR": [
    { name: "models/DMSO_72HR.glb", label: "DMSO" },
    { name: "models/100_72HR.glb", label: "100 µM" },
    { name: "models/300_72HR.glb", label: "300 µM" }
  ],
  "96HR": [
    { name: "models/DMSO_96HR.glb", label: "DMSO" },
    { name: "models/100_96HR.glb", label: "100 µM" },
    { name: "models/300_96HR.glb", label: "300 µM" }
  ]
};

let currentTimepoint = "0HR";
let currentDoseLabel = "DMSO";

/* TIMEPOINT BUTTONS */
Object.keys(timepoints).forEach(tp => {
  const btn = document.createElement('button');
  btn.textContent = tp;
  btn.onclick = () => {
    document.querySelectorAll('.timepoint-buttons button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentTimepoint = tp;
    renderDoseButtons();
  };
  tpButtonsDiv.appendChild(btn);
});

/* DOSE BUTTONS */
function renderDoseButtons() {
  doseButtonsDiv.innerHTML = '';
  timepoints[currentTimepoint].forEach((model, idx) => {
    const btn = document.createElement('button');
    btn.textContent = model.label;
    btn.onclick = () => {
      document.querySelectorAll('.dose-buttons button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentDoseLabel = model.label;
      viewer.src = model.name;
    };
    if (idx === 0) btn.classList.add('active');
    doseButtonsDiv.appendChild(btn);
  });

  currentDoseLabel = timepoints[currentTimepoint][0].label;
  viewer.src = timepoints[currentTimepoint][0].name;
}

/* ------------------ TMRE VISIBILITY ------------------ */
const TMRE_MATERIAL_NAME = 'TMRE_Mat';
let tmreVisible = true;
let tmreMaterials = [];

function getTMREAlpha(dose, timepoint) {
  // DMSO always
  if (dose === "DMSO") return 0.2;

  // 0HR specific cases
  if (timepoint === "0HR") {
    if (dose === "100 µM") return 0.5;
    if (dose === "300 µM") return 0.36;
  }

  // fallback for all other conditions
  return 0.1;
}


function acquireTMREMaterials() {
  if (!viewer.model) {
    requestAnimationFrame(acquireTMREMaterials);
    return;
  }
  tmreMaterials = [];
  const mat = viewer.model.getMaterialByName(TMRE_MATERIAL_NAME);
  if (mat) tmreMaterials.push(mat);
  applyTMREVisibility();
}

function applyTMREVisibility() {
  const alpha = getTMREAlpha(currentDoseLabel, currentTimepoint);
  tmreMaterials.forEach(mat => {
    const base = mat.pbrMetallicRoughness.baseColorFactor;
    mat.setAlphaMode('BLEND');
    mat.pbrMetallicRoughness.setBaseColorFactor([
      base[0], base[1], base[2],
      tmreVisible ? alpha : 0
    ]);
  });
  viewer.requestUpdate();
}

viewer.addEventListener('load', acquireTMREMaterials);

document.getElementById('toggleTMRE').onclick = () => {
  tmreVisible = !tmreVisible;
  applyTMREVisibility();
  document.getElementById('toggleTMRE').textContent =
    tmreVisible ? 'Hide TMRE' : 'Show TMRE';
};

/* INITIAL STATE */
document.querySelectorAll('.timepoint-buttons button')[0].classList.add('active');
renderDoseButtons();
</script>

</body>
</html>


